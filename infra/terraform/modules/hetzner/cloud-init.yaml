#cloud-config
# This cloud-init configuration fixes the private network interface
# to use /16 netmask so all 10.1.x.x subnets can communicate
# It also adds routing for home network (10.10.0.0/16) via pfSense
# It dynamically detects the private network interface

runcmd:
  # Find the interface with IP ${private_ip} (private network interface)
  - |
    PRIVATE_IFACE=$(ip -o addr show | grep "${private_ip}" | awk '{print $2}')
    if [ -n "$PRIVATE_IFACE" ]; then
      cat > /etc/netplan/60-hetzner-private-network.yaml <<EOF
    network:
      version: 2
      ethernets:
        $PRIVATE_IFACE:
          dhcp4: no
          addresses:
            - ${private_ip}/16
          routes:
            - to: 10.1.0.0/16
              via: 10.1.0.1
              metric: 100
            - to: 10.10.0.0/16
              via: 10.1.0.2
              metric: 100
    EOF
      chmod 600 /etc/netplan/60-hetzner-private-network.yaml
      netplan apply
      systemctl restart systemd-networkd
    fi
