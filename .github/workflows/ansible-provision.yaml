name: Ansible Provision

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "infra/ansible/**"
      - ".github/workflows/ansible-provision.yaml"

jobs:
  create-runner:
    name: Create Hetzner Cloud runner
    runs-on: ubuntu-24.04
    outputs:
      label: ${{ steps.create-hcloud-runner.outputs.label }}
      server_id: ${{ steps.create-hcloud-runner.outputs.server_id }}
    steps:
      - name: Create runner
        id: create-hcloud-runner
        uses: Cyclenerd/hcloud-github-runner@v1.3.0
        with:
          mode: create
          github_token: ${{ secrets.HETZNER_GHA_RUNNER_PAT }}
          hcloud_token: ${{ secrets.HETZNER_API_TOKEN }}
          network: ${{ secrets.HETZNER_NETWORK_ID }}
          ssh_key: ${{ secrets.HETZNER_GHA_RUNNER_SSH_KEY_ID }}
          server_type: cx23
          location: hel1
          image: ubuntu-24.04
          pre_runner_script: |
            set -ex
            echo "Configuring private network routing..."
            sleep 10
            PRIVATE_IFACE=$(ip -o addr show | grep "10.1.1." | awk '{print $2}' | head -n1)
            if [ -z "$PRIVATE_IFACE" ]; then
              echo "No private interface found in 10.1.1.0/24 subnet, skipping network configuration"
              exit 0
            fi
            PRIVATE_IP=$(ip -o -4 addr show $PRIVATE_IFACE | awk '{print $4}' | cut -d/ -f1)
            echo "Found interface $PRIVATE_IFACE with IP $PRIVATE_IP"
            cat > /etc/netplan/60-private-network.yaml <<'NETPLAN_EOF'
            network:
              version: 2
              renderer: networkd
              ethernets:
                PLACEHOLDER_IFACE:
                  dhcp4: false
                  dhcp6: false
                  accept-ra: false
                  addresses:
                    - PLACEHOLDER_IP/32
                  routes:
                    - to: 10.1.0.0/16
                      via: 10.1.0.1
                      on-link: true
                      metric: 100
                  nameservers:
                    addresses:
                      - 1.1.1.1
                      - 1.0.0.1
            NETPLAN_EOF
            sed -i "s/PLACEHOLDER_IFACE/$PRIVATE_IFACE/g" /etc/netplan/60-private-network.yaml
            sed -i "s|PLACEHOLDER_IP|$PRIVATE_IP|g" /etc/netplan/60-private-network.yaml
            netplan apply
            echo "Network configuration applied successfully"
            ip route show

  ansible-provision:
    needs: create-runner
    runs-on: ${{ needs.create-runner.outputs.label }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Setup Python
        uses: actions/setup-python@v5.6.0
        with:
          python-version: "3.13"

      - name: Install Ansible and dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install ansible ansible-lint

      - name: Lint Ansible Playbook
        run: |
          ansible-lint infra/ansible/playbook.yml || exit_code=$?
          if [ "$exit_code" -ne 0 ]; then
            echo "❌ Linting failed with exit code $exit_code"
            exit $exit_code
          else
            echo "✅ Linting succeeded"
            exit 0
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ vars.SERVER_IP_SALKO0 }} >> ~/.ssh/known_hosts

      - name: Ping test server
        env:
          SERVER_IPS: ${{ vars.SERVER_IP_SALKO0 }}
          ANSIBLE_HOST_KEY_CHECKING: False
          ANSIBLE_FORCE_COLOR: True
        run: |
          chmod +x infra/ansible/inventory.py
          ansible -m ping all \
            --inventory infra/ansible/inventory.py \
            --user root \
            --private-key ~/.ssh/id_ed25519 \
            --extra-vars "ansible_ssh_common_args='-o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'" || exit_code=$?

          if [ "$exit_code" -ne 0 ]; then
            echo "❌ Ping failed with exit code $exit_code"
            exit $exit_code
          else
            echo "✅ Ping succeeded"
          fi

      - name: Debug network connectivity
        env:
          SERVER_IPS: ${{ vars.SERVER_IP_SALKO0 }}
          ANSIBLE_HOST_KEY_CHECKING: False
          ANSIBLE_FORCE_COLOR: True
        run: |
          echo "=== Checking runner connectivity ==="
          echo "Runner can reach internet:"
          curl -s -o /dev/null -w "%{http_code}" https://archive.ubuntu.com || echo "Failed"
          echo ""

          echo "=== Checking target server connectivity ==="
          ansible all \
            --inventory infra/ansible/inventory.py \
            --user root \
            --private-key ~/.ssh/id_ed25519 \
            --extra-vars "ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'" \
            -m shell \
            -a "ip route show; echo '---'; ping -c 2 1.1.1.1; echo '---'; curl -s -o /dev/null -w '%{http_code}' https://archive.ubuntu.com" || echo "Debug failed"

      - name: Ansible Playbook
        env:
          SERVER_IPS: ${{ vars.SERVER_IP_SALKO0 }}
          VPS_PUBLIC_KEY: ${{ secrets.VPS_PUBLIC_KEY }}
          SALKO_USER_PW_512: ${{ secrets.SALKO_USER_PW_512 }}
          ANSIBLE_HOST_KEY_CHECKING: False
          ANSIBLE_FORCE_COLOR: True
        run: |
          chmod +x infra/ansible/inventory.py 
          ansible-playbook infra/ansible/playbook.yml \
            --verbose \
            --user root \
            --private-key ~/.ssh/id_ed25519 \
            --inventory infra/ansible/inventory.py \
            --extra-vars "ansible_ssh_common_args='-o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'" || exit_code=$?
          
          if [ "$exit_code" -ne 0 ]; then
            echo "❌ Ansible playbook execution failed with exit code $exit_code"
            exit $exit_code
          else
            echo "✅ Ansible playbook executed successfully"
          fi

  delete-runner:
    name: Delete Hetzner Cloud runner
    needs:
      - create-runner
      - ansible-provision
    runs-on: ubuntu-24.04
    if: ${{ always() }}
    steps:
      - name: Delete runner
        uses: Cyclenerd/hcloud-github-runner@v1.3.0
        with:
          mode: delete
          github_token: ${{ secrets.HETZNER_GHA_RUNNER_PAT }}
          hcloud_token: ${{ secrets.HETZNER_API_TOKEN }}
          name: ${{ needs.create-runner.outputs.label }}
          server_id: ${{ needs.create-runner.outputs.server_id }}