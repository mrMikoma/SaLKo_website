name: Deploy Traefik

on:
  workflow_dispatch:

jobs:
  create-runner:
    name: Create Hetzner Cloud runner
    runs-on: ubuntu-24.04
    outputs:
      label: ${{ steps.create-hcloud-runner.outputs.label }}
      server_id: ${{ steps.create-hcloud-runner.outputs.server_id }}
    steps:
      - name: Create runner
        id: create-hcloud-runner
        uses: Cyclenerd/hcloud-github-runner@v1.3.0
        with:
          mode: create
          github_token: ${{ secrets.HETZNER_GHA_RUNNER_PAT }}
          hcloud_token: ${{ secrets.HETZNER_API_TOKEN }}
          network: ${{ secrets.HETZNER_NETWORK_ID }}
          ssh_key: ${{ secrets.HETZNER_GHA_RUNNER_SSH_KEY_ID }}
          server_type: cx23
          location: hel1
          image: ubuntu-24.04
          pre_runner_script: |
            set -ex
            echo "Configuring private network routing..."
            sleep 10
            PRIVATE_IFACE=$(ip -o addr show | grep "10.1.1." | awk '{print $2}' | head -n1)
            if [ -z "$PRIVATE_IFACE" ]; then
              echo "No private interface found in 10.1.1.0/24 subnet, skipping network configuration"
              exit 0
            fi
            PRIVATE_IP=$(ip -o -4 addr show $PRIVATE_IFACE | awk '{print $4}' | cut -d/ -f1)
            echo "Found interface $PRIVATE_IFACE with IP $PRIVATE_IP"
            cat > /etc/netplan/60-private-network.yaml <<'NETPLAN_EOF'
            network:
              version: 2
              renderer: networkd
              ethernets:
                PLACEHOLDER_IFACE:
                  dhcp4: false
                  dhcp6: false
                  accept-ra: false
                  addresses:
                    - PLACEHOLDER_IP/32
                  routes:
                    - to: 10.1.0.0/16
                      via: 10.1.0.1
                      on-link: true
                      metric: 100
                  nameservers:
                    addresses:
                      - 1.1.1.1
                      - 1.0.0.1
            NETPLAN_EOF
            sed -i "s/PLACEHOLDER_IFACE/$PRIVATE_IFACE/g" /etc/netplan/60-private-network.yaml
            sed -i "s|PLACEHOLDER_IP|$PRIVATE_IP|g" /etc/netplan/60-private-network.yaml
            netplan apply
            echo "Network configuration applied successfully"
            ip route show

  deploy:
    needs: create-runner
    runs-on: ${{ needs.create-runner.outputs.label }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ vars.SERVER_IP_SALKO0 }} >> ~/.ssh/known_hosts

      - name: Transfer Traefik configuration files to SERVER
        run: |
          scp -i ~/.ssh/id_ed25519 ./traefik/docker-compose.traefik.yaml salko@${{ vars.SERVER_IP_SALKO0 }}:/home/salko/traefik/docker-compose.traefik.yaml
          scp -i ~/.ssh/id_ed25519 ./traefik/traefik.yaml salko@${{ vars.SERVER_IP_SALKO0 }}:/home/salko/traefik/traefik.yaml

      - name: Deploy to SERVER
        run: |
          ssh -i ~/.ssh/id_ed25519 salko@${{ vars.SERVER_IP_SALKO0 }} << "EOF"
            cd traefik/

            # Create or clear the .env.traefik file
            > .env.traefik

            # Append environment variables one by one
            echo "CF_DNS_API_TOKEN=${{ secrets.CF_API_TOKEN }}" >> .env.traefik

            # Ensure the environment variables are written before proceeding
            echo ".env.traefik file created with environment variables."

            # Stop the current containers
            echo "Stopping the current containers..."
            docker compose --env-file .env.traefik -f docker-compose.traefik.yaml down || true

            # Start the containers using Docker Compose
            echo "Starting containers using Docker Compose..."
            docker compose --env-file .env.traefik -f docker-compose.traefik.yaml up -d

            echo "Cleaning up old images..."
            docker image prune -f

            echo "Deployment complete."
          EOF

  delete-runner:
    name: Delete Hetzner Cloud runner
    needs:
      - create-runner
      - deploy
    runs-on: ubuntu-24.04
    if: ${{ always() }}
    steps:
      - name: Delete runner
        uses: Cyclenerd/hcloud-github-runner@v1.3.0
        with:
          mode: delete
          github_token: ${{ secrets.HETZNER_GHA_RUNNER_PAT }}
          hcloud_token: ${{ secrets.HETZNER_API_TOKEN }}
          name: ${{ needs.create-runner.outputs.label }}
          server_id: ${{ needs.create-runner.outputs.server_id }}
